########-------PRINT_START---------
[gcode_macro PRINT_START]
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.TOOL_TEMP|default(190)|float %}
    {% set initial_tool = params.TOOL|default(0)|int %}

    # ---- Vorbereitung: Bett & T0 für QGL ----
    M104 T0 S150
    M190 S{BED_TEMP}

    # ---- Parallel andere Tools vorheizen (außer T0) ----
    {% for tool_nr in printer.toolchanger.tool_numbers %}
        {% if tool_nr != 0 %}
            {% set tooltemp_param = 'T' ~ tool_nr|string ~ '_TEMP' %}
            {% if tooltemp_param in params %}
                M104 T{tool_nr} S{params[tooltemp_param]}
                G4 P500  ; kurze Pause (Stromlimit)
            {% endif %}
        {% endif %}
    {% endfor %}

    # ---- Leveling / Mesh ----
    Initial_Toolchanger
    BED_MESH_CLEAR 
    G90
    G28
    QUAD_GANTRY_LEVEL
    G28 Z
    BED_MESH_CALIBRATE ADAPTIVE=1
    G1 Z5 F3000

    # ---- Nach QGL: Verhalten abhängig von T0-Nutzung ----
    {% set t0_used = 'T0_TEMP' in params %}
    {% if t0_used %}
        M104 T0 S{params.T0_TEMP}
    {% else %}
        M104 T0 S0
    {% endif %}

    # ---- Warten, bis alle tatsächlich genutzten Tools heiß sind ----
    {% for tool_nr in printer.toolchanger.tool_numbers %}
        {% set tooltemp_param = 'T' ~ tool_nr|string ~ '_TEMP' %}
        {% if tooltemp_param in params %}
            M109 T{tool_nr} S{params[tooltemp_param]}
        {% endif %}
    {% endfor %}

    # ---- Prime Lines ----
    PRIME_LINES INITIAL_TOOL={initial_tool}

    M118 "Ready to Rock"
